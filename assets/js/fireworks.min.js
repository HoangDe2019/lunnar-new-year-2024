"use strict";console.clear();const IS_MOBILE=window.innerWidth<=640,IS_DESKTOP=window.innerWidth>800,IS_HEADER=IS_DESKTOP&&window.innerHeight<300,IS_HIGH_END_DEVICE=(()=>{let e=navigator.hardwareConcurrency;return!!e&&e>=(window.innerWidth<=1024?4:8)})(),MAX_WIDTH=7680,MAX_HEIGHT=4320,GRAVITY=.9;let simSpeed=1;function getDefaultScaleFactor(){return IS_MOBILE?.9:IS_HEADER?.75:1}let stageW,stageH,quality=1,isLowQuality=!1,isNormalQuality=!0,isHighQuality=!1;const QUALITY_LOW=1,QUALITY_NORMAL=2,QUALITY_HIGH=3,SKY_LIGHT_NONE=0,SKY_LIGHT_DIM=1,SKY_LIGHT_NORMAL=2,COLOR={Red:"#ff0043",Green:"#14fc56",Blue:"#1e7fff",Purple:"#e60aff",Gold:"#ffbf36",White:"#ffffff"},INVISIBLE="_INVISIBLE_",PI_2=2*Math.PI,PI_HALF=.5*Math.PI,trailsStage=new Stage("trails-canvas"),mainStage=new Stage("main-canvas"),stages=[trailsStage,mainStage];function fullscreenEnabled(){return fscreen.fullscreenEnabled}function isFullscreen(){return!!fscreen.fullscreenElement}function toggleFullscreen(){fullscreenEnabled()&&(isFullscreen()?fscreen.exitFullscreen():fscreen.requestFullscreen(document.documentElement))}fscreen.addEventListener("fullscreenchange",(()=>{store.setState({fullscreen:isFullscreen()})}));const store={_listeners:new Set,_dispatch(e){this._listeners.forEach((t=>t(this.state,e)))},state:{paused:!0,menuOpen:!1,openHelpTopic:null,fullscreen:isFullscreen(),config:{quality:String(IS_HIGH_END_DEVICE?3:2),shell:"Random",size:IS_DESKTOP?"3":IS_HEADER?"1.2":"2",autoLaunch:!0,finale:!1,skyLighting:"2",hideControls:IS_HEADER,longExposure:!1,scaleFactor:getDefaultScaleFactor()}},setState(e){let t=this.state;this.state=Object.assign({},this.state,e),this._dispatch(t)},subscribe(e){return this._listeners.add(e),()=>this._listeners.remove(e)}};function togglePause(e){let t,r=store.state.paused;t="boolean"==typeof e?e:!r,r!==t&&store.setState({paused:t})}function updateConfig(e){e=e||getConfigFromDOM(),store.setState({config:Object.assign({},store.state.config,e)}),configDidUpdate()}function configDidUpdate(){store.state.config,isLowQuality=1===(quality=qualitySelector()),isNormalQuality=2===quality,isHighQuality=3===quality,0===skyLightingSelector()&&(appNodes.canvasContainer.style.backgroundColor="transparent"),Spark.drawWidth=3===quality?.75:1}const isRunning=(e=store.state)=>!e.paused&&!e.menuOpen,qualitySelector=()=>+store.state.config.quality,shellNameSelector=()=>store.state.config.shell,shellSizeSelector=()=>+store.state.config.size,finaleSelector=()=>store.state.config.finale,skyLightingSelector=()=>+store.state.config.skyLighting,scaleFactorSelector=()=>store.state.config.scaleFactor,nodeKeyToHelpKey={shellTypeLabel:"shellType",shellSizeLabel:"shellSize",qualityLabel:"quality",skyLightingLabel:"skyLighting",scaleFactorLabel:"scaleFactor",autoLaunchLabel:"autoLaunch",finaleModeLabel:"finaleMode",hideControlsLabel:"hideControls",fullscreenLabel:"fullscreen",longExposureLabel:"longExposure"},appNodes={stageContainer:".stage-container__firework",canvasContainer:".canvas-container__firework"};function getConfigFromDOM(){return{quality:appNodes.quality.value,shell:appNodes.shellType.value,size:appNodes.shellSize.value,autoLaunch:appNodes.autoLaunch.checked,finale:appNodes.finaleMode.checked,skyLighting:appNodes.skyLighting.value,longExposure:appNodes.longExposure.checked,hideControls:appNodes.hideControls.checked,scaleFactor:parseFloat(appNodes.scaleFactor.value)}}Object.keys(appNodes).forEach((e=>{appNodes[e]=document.querySelector(appNodes[e])})),fullscreenEnabled()||appNodes.fullscreenFormOption.classList.add("remove");const updateConfigNoEvent=()=>updateConfig(),COLOR_NAMES=Object.keys(COLOR),COLOR_CODES=COLOR_NAMES.map((e=>COLOR[e])),COLOR_CODES_W_INVIS=[...COLOR_CODES,INVISIBLE],COLOR_CODE_INDEXES=COLOR_CODES_W_INVIS.reduce(((e,t,r)=>(e[t]=r,e)),{}),COLOR_TUPLES={};function randomColorSimple(){return COLOR_CODES[Math.random()*COLOR_CODES.length|0]}let lastColor;function randomColor(e){let t=e&&e.notSame,r=e&&e.notColor,a=e&&e.limitWhite,l=randomColorSimple();if(a&&l===COLOR.White&&.6>Math.random()&&(l=randomColorSimple()),t)for(;l===lastColor;)l=randomColorSimple();else if(r)for(;l===r;)l=randomColorSimple();return lastColor=l,l}function whiteOrGold(){return.5>Math.random()?COLOR.Gold:COLOR.White}function makePistilColor(e){return e===COLOR.White||e===COLOR.Gold?randomColor({notColor:e}):whiteOrGold()}COLOR_CODES.forEach((e=>{COLOR_TUPLES[e]={r:parseInt(e.substr(1,2),16),g:parseInt(e.substr(3,2),16),b:parseInt(e.substr(5,2),16)}}));const crysanthemumShell=(e=1)=>{let t=.25>Math.random(),r=.72>Math.random(),a=r?randomColor({limitWhite:!0}):[randomColor(),randomColor({notSame:!0})],l=r&&.42>Math.random(),o=l&&makePistilColor(a),i=r&&(.2>Math.random()||a===COLOR.White)?o||randomColor({notColor:a,limitWhite:!0}):null,s=!l&&a!==COLOR.White&&.42>Math.random(),n=t?1.1:1.25;return isLowQuality&&(n*=.8),isHighQuality&&(n=1.2),{shellSize:e,spreadSize:300+100*e,starLife:900+200*e,starDensity:n,color:a,secondColor:i,glitter:t?"light":"",glitterColor:whiteOrGold(),pistil:l,pistilColor:o,streamers:s}},ghostShell=(e=1)=>{let t=crysanthemumShell(e);t.starLife*=1.5;let r=randomColor({notColor:COLOR.White});return t.streamers=!0,.42>Math.random()&&makePistilColor(r),t.color=INVISIBLE,t.secondColor=r,t.glitter="",t},strobeShell=(e=1)=>{let t=randomColor({limitWhite:!0});return{shellSize:e,spreadSize:280+92*e,starLife:1100+200*e,starLifeVariation:.4,starDensity:1.1,color:t,glitter:"light",glitterColor:COLOR.White,strobe:!0,strobeColor:.5>Math.random()?COLOR.White:null,pistil:.5>Math.random(),pistilColor:makePistilColor(t)}},palmShell=(e=1)=>{let t=randomColor(),r=.5>Math.random();return{shellSize:e,color:t,spreadSize:250+75*e,starDensity:r?.15:.4,starLife:1800+200*e,glitter:r?"thick":"heavy"}},ringShell=(e=1)=>{let t=randomColor(),r=.75>Math.random();return{shellSize:e,ring:!0,color:t,spreadSize:300+100*e,starLife:900+200*e,starCount:2.2*PI_2*(e+1),pistil:r,pistilColor:makePistilColor(t),glitter:r?"":"light",glitterColor:t===COLOR.Gold?COLOR.Gold:COLOR.White,streamers:.3>Math.random()}},crossetteShell=(e=1)=>{let t=randomColor({limitWhite:!0});return{shellSize:e,spreadSize:300+100*e,starLife:750+160*e,starLifeVariation:.4,starDensity:.85,color:t,crossette:!0,pistil:.5>Math.random(),pistilColor:makePistilColor(t)}},floralShell=(e=1)=>({shellSize:e,spreadSize:300+120*e,starDensity:.12,starLife:500+50*e,starLifeVariation:.5,color:.65>Math.random()?"random":.15>Math.random()?randomColor():[randomColor(),randomColor({notSame:!0})],floral:!0}),fallingLeavesShell=(e=1)=>({shellSize:e,color:INVISIBLE,spreadSize:300+120*e,starDensity:.12,starLife:500+50*e,starLifeVariation:.5,glitter:"medium",glitterColor:COLOR.Gold,fallingLeaves:!0}),willowShell=(e=1)=>({shellSize:e,spreadSize:300+100*e,starDensity:.6,starLife:3e3+300*e,glitter:"willow",glitterColor:COLOR.Gold,color:INVISIBLE}),crackleShell=(e=1)=>{let t=.75>Math.random()?COLOR.Gold:randomColor();return{shellSize:e,spreadSize:380+75*e,starDensity:isLowQuality?.65:1,starLife:600+100*e,starLifeVariation:.32,glitter:"light",glitterColor:COLOR.Gold,color:t,crackle:!0,pistil:.65>Math.random(),pistilColor:makePistilColor(t)}},horsetailShell=(e=1)=>{let t=randomColor();return{shellSize:e,horsetail:!0,color:t,spreadSize:250+38*e,starDensity:.9,starLife:2500+300*e,glitter:"medium",glitterColor:.5>Math.random()?whiteOrGold():t,strobe:t===COLOR.White}};function randomShellName(){return.5>Math.random()?"Crysanthemum":shellNames[Math.random()*(shellNames.length-1)+1|0]}function randomShell(e){return IS_HEADER?randomFastShell()(e):shellTypes[randomShellName()](e)}function shellFromConfig(e){return shellTypes[shellNameSelector()](e)}const fastShellBlacklist=["Falling Leaves","Floral","Willow"];function randomFastShell(){let e="Random"===shellNameSelector(),t=e?randomShellName():shellNameSelector();if(e)for(;fastShellBlacklist.includes(t);)t=randomShellName();return shellTypes[t]}const shellTypes={Random:randomShell,Crackle:crackleShell,Crossette:crossetteShell,Crysanthemum:crysanthemumShell,"Falling Leaves":fallingLeavesShell,Floral:floralShell,Ghost:ghostShell,"Horse Tail":horsetailShell,Palm:palmShell,Ring:ringShell,Strobe:strobeShell,Willow:willowShell},shellNames=Object.keys(shellTypes);function init(){togglePause(!1),configDidUpdate()}function fitShellPositionInBoundsH(e){return.64*e+.18}function fitShellPositionInBoundsV(e){return.75*e}function getRandomShellPositionH(){return fitShellPositionInBoundsH(Math.random())}function getRandomShellPositionV(){return fitShellPositionInBoundsV(Math.random())}function getRandomShellSize(){let e=shellSizeSelector(),t=Math.min(2.5,e),r=Math.random()*t,a=0===t?Math.random():1-r/t,l=Math.random()*(1-.65*a)*.5;return{size:e-r,x:fitShellPositionInBoundsH(.5>Math.random()?.5-l:.5+l),height:fitShellPositionInBoundsV(a)}}function launchShellFromConfig(e){let t=new Shell(shellFromConfig(shellSizeSelector())),r=mainStage.width,a=mainStage.height;t.launch(e?e.x/r:getRandomShellPositionH(),e?1-e.y/a:getRandomShellPositionV())}function seqRandomShell(){let e=getRandomShellSize(),t=new Shell(shellFromConfig(e.size));t.launch(e.x,e.height);let r=t.starLife;return t.fallingLeaves&&(r=4600),900+600*Math.random()+r}function seqRandomFastShell(){let e=randomFastShell(),t=getRandomShellSize(),r=new Shell(e(t.size));return r.launch(t.x,t.height),900+600*Math.random()+r.starLife}function seqTwoRandom(){let e=getRandomShellSize(),t=getRandomShellSize(),r=new Shell(shellFromConfig(e.size)),a=new Shell(shellFromConfig(t.size)),l=.2*Math.random()-.1;r.launch(.2*Math.random()-.1+.3,e.height),setTimeout((()=>{a.launch(.7+l,t.height)}),100);let o=Math.max(r.starLife,a.starLife);return(r.fallingLeaves||a.fallingLeaves)&&(o=4600),900+600*Math.random()+o}function seqTriple(){let e=randomFastShell(),t=shellSizeSelector(),r=Math.max(0,t-1.25);return new Shell(e(t)).launch(.08*Math.random()-.04+.5,.7),setTimeout((()=>{new Shell(e(r)).launch(.08*Math.random()-.04+.2,.1)}),1e3+400*Math.random()),setTimeout((()=>{new Shell(e(r)).launch(.08*Math.random()-.04+.8,.1)}),1e3+400*Math.random()),4e3}function seqPyramid(){let e=IS_DESKTOP?7:4,t=shellSizeSelector(),r=Math.max(0,t-3),a=.78>Math.random()?crysanthemumShell:ringShell,l=randomShell;function o(e,o){let i="Random"===shellNameSelector()?o?l:a:shellTypes[shellNameSelector()];new Shell(i(o?t:r)).launch(e,o?.75:.42*(e<=.5?e/.5:(1-e)/.5))}let i=0,s=0;for(;i<=e;){if(i===e)setTimeout((()=>{o(.5,!0)}),s);else{let t=i/e*.5,r=30*Math.random()+30;setTimeout((()=>{o(t,!1)}),s),setTimeout((()=>{o(1-t,!1)}),s+r)}i++,s+=200}return 3400+250*e}function seqSmallBarrage(){seqSmallBarrage.lastCalled=Date.now();let e=IS_DESKTOP?11:5,t=IS_DESKTOP?3:1,r=Math.max(0,shellSizeSelector()-2),a=.78>Math.random()?crysanthemumShell:ringShell,l=randomFastShell();function o(e,t){let o="Random"===shellNameSelector()?t?l:a:shellTypes[shellNameSelector()];new Shell(o(r)).launch(e,(Math.cos(5*e*Math.PI+PI_HALF)+1)/2*.75)}let i=0,s=0;for(;i<e;){if(0===i)o(.5,!1),i+=1;else{let r=(i+1)/e/2,a=30*Math.random()+30,l=i===t;setTimeout((()=>{o(.5+r,l)}),s),setTimeout((()=>{o(.5-r,l)}),s+a),i+=2}s+=200}return 3400+120*e}seqSmallBarrage.cooldown=15e3,seqSmallBarrage.lastCalled=Date.now();const sequences=[seqRandomShell,seqTwoRandom,seqTriple,seqPyramid,seqSmallBarrage];let isFirstSeq=!0;const finaleCount=32;let currentFinaleCount=0;function startSequence(){if(isFirstSeq){if(isFirstSeq=!1,IS_HEADER)return seqTwoRandom();return new Shell(crysanthemumShell(shellSizeSelector())).launch(.5,.5),2400}if(finaleSelector())return seqRandomFastShell(),currentFinaleCount<32?(currentFinaleCount++,170):(currentFinaleCount=0,6e3);let e=Math.random();return e<.08&&Date.now()-seqSmallBarrage.lastCalled>seqSmallBarrage.cooldown?seqSmallBarrage():e<.1?seqPyramid():e<.6&&!IS_HEADER?seqRandomShell():e<.8?seqTwoRandom():e<1?seqTriple():void 0}let activePointerCount=0,isUpdatingSpeed=!1;function handlePointerStart(e){activePointerCount++,(!(e.y<50)||!(e.x>mainStage.width/2-25)||!(e.x<mainStage.width/2+25))&&isRunning()&&(updateSpeedFromEvent(e)?isUpdatingSpeed=!0:e.onCanvas&&launchShellFromConfig(e))}function handlePointerEnd(e){activePointerCount--,isUpdatingSpeed=!1}function handlePointerMove(e){isRunning()&&isUpdatingSpeed&&updateSpeedFromEvent(e)}function handleResize(){let e=window.innerWidth,t=window.innerHeight,r=Math.min(e,7680),a=e<=420?t:Math.min(t,4320);appNodes.stageContainer.style.width=r+"px",appNodes.stageContainer.style.height=a+"px",stages.forEach((e=>e.resize(r,a)));let l=scaleFactorSelector();stageW=r/l,stageH=a/l}mainStage.addEventListener("pointerstart",handlePointerStart),mainStage.addEventListener("pointerend",handlePointerEnd),mainStage.addEventListener("pointermove",handlePointerMove),handleResize(),window.addEventListener("resize",handleResize);let currentFrame=0,speedBarOpacity=0,autoLaunchTime=0;function updateSpeedFromEvent(e){if(isUpdatingSpeed||e.y>=mainStage.height-44){let t=(e.x-16)/(mainStage.width-32);return simSpeed=Math.min(Math.max(t,0),1),speedBarOpacity=1,!0}return!1}function updateGlobals(e,t){currentFrame++,!isUpdatingSpeed&&(speedBarOpacity-=t/30)<0&&(speedBarOpacity=0),store.state.config.autoLaunch&&(autoLaunchTime-=e)<=0&&(autoLaunchTime=1.25*startSequence())}function update(e,t){if(!isRunning())return;let r=e*simSpeed,a=simSpeed*t;updateGlobals(r,t);let l=1-(1-Star.airDrag)*a,o=1-(1-Star.airDragHeavy)*a,i=1-(1-Spark.airDrag)*a,s=r/1e3*.9;COLOR_CODES_W_INVIS.forEach((e=>{let t=Star.active[e];for(let e=t.length-1;e>=0;e-=1){let i=t[e];if(i.updateFrame!==currentFrame)if(i.updateFrame=currentFrame,i.life-=r,i.life<=0)t.splice(e,1),Star.returnInstance(i);else{let n=Math.pow(i.life/i.fullLife,.5),h=1-n;if(i.prevX=i.x,i.prevY=i.y,i.x+=i.speedX*a,i.y+=i.speedY*a,i.heavy?(i.speedX*=o,i.speedY*=o):(i.speedX*=l,i.speedY*=l),i.speedY+=s,i.spinRadius&&(i.spinAngle+=i.spinSpeed*a,i.x+=Math.sin(i.spinAngle)*i.spinRadius*a,i.y+=Math.cos(i.spinAngle)*i.spinRadius*a),i.sparkFreq)for(i.sparkTimer-=r;i.sparkTimer<0;)i.sparkTimer+=.75*i.sparkFreq+i.sparkFreq*h*4,Spark.add(i.x,i.y,i.sparkColor,Math.random()*PI_2,Math.random()*i.sparkSpeed*n,.8*i.sparkLife+Math.random()*i.sparkLifeVariation*i.sparkLife);i.life<i.transitionTime&&(i.secondColor&&!i.colorChanged&&(i.colorChanged=!0,i.color=i.secondColor,t.splice(e,1),Star.active[i.secondColor].push(i),i.secondColor===INVISIBLE&&(i.sparkFreq=0)),i.strobe&&(i.visible=Math.floor(i.life/i.strobeFreq)%3==0))}}let n=Spark.active[e];for(let e=n.length-1;e>=0;e-=1){let t=n[e];t.life-=r,t.life<=0?(n.splice(e,1),Spark.returnInstance(t)):(t.prevX=t.x,t.prevY=t.y,t.x+=t.speedX*a,t.y+=t.speedY*a,t.speedX*=i,t.speedY*=i,t.speedY+=s)}})),render(a)}function render(e){let{dpr:t}=mainStage,r=stageW,a=stageH,l=trailsStage.ctx,o=mainStage.ctx;0!==skyLightingSelector()&&colorSky(e);let i=scaleFactorSelector();for(l.scale(t*i,t*i),o.scale(t*i,t*i),l.globalCompositeOperation="source-over",l.fillStyle=`rgba(0, 0, 0, ${store.state.config.longExposure?.0025:.175*e})`,l.fillRect(0,0,r,a),o.clearRect(0,0,r,a);BurstFlash.active.length;){let e=BurstFlash.active.pop(),t=l.createRadialGradient(e.x,e.y,0,e.x,e.y,e.radius);t.addColorStop(.024,"rgba(255, 255, 255, 1)"),t.addColorStop(.125,"rgba(255, 160, 20, 0.2)"),t.addColorStop(.32,"rgba(255, 140, 20, 0.11)"),t.addColorStop(1,"rgba(255, 120, 20, 0)"),l.fillStyle=t,l.fillRect(e.x-e.radius,e.y-e.radius,2*e.radius,2*e.radius),BurstFlash.returnInstance(e)}l.globalCompositeOperation="lighten",l.lineWidth=Star.drawWidth,l.lineCap=isLowQuality?"square":"round",o.strokeStyle="#fff",o.lineWidth=1,o.beginPath(),COLOR_CODES.forEach((e=>{let t=Star.active[e];l.strokeStyle=e,l.beginPath(),t.forEach((e=>{e.visible&&(l.moveTo(e.x,e.y),l.lineTo(e.prevX,e.prevY),o.moveTo(e.x,e.y),o.lineTo(e.x-1.6*e.speedX,e.y-1.6*e.speedY))})),l.stroke()})),o.stroke(),l.lineWidth=Spark.drawWidth,l.lineCap="butt",COLOR_CODES.forEach((e=>{let t=Spark.active[e];l.strokeStyle=e,l.beginPath(),t.forEach((e=>{l.moveTo(e.x,e.y),l.lineTo(e.prevX,e.prevY)})),l.stroke()})),speedBarOpacity&&(o.globalAlpha=speedBarOpacity,o.fillStyle=COLOR.Blue,o.fillRect(0,a-6,r*simSpeed,6),o.globalAlpha=1),l.setTransform(1,0,0,1,0,0),o.setTransform(1,0,0,1,0,0)}const currentSkyColor={r:0,g:0,b:0},targetSkyColor={r:0,g:0,b:0};function colorSky(e){let t=15*skyLightingSelector(),r=0;targetSkyColor.r=0,targetSkyColor.g=0,targetSkyColor.b=0,COLOR_CODES.forEach((e=>{let t=COLOR_TUPLES[e],a=Star.active[e].length;r+=a,targetSkyColor.r+=t.r*a,targetSkyColor.g+=t.g*a,targetSkyColor.b+=t.b*a}));let a=Math.pow(Math.min(1,r/500),.3),l=Math.max(1,targetSkyColor.r,targetSkyColor.g,targetSkyColor.b);targetSkyColor.r=targetSkyColor.r/l*t*a,targetSkyColor.g=targetSkyColor.g/l*t*a,targetSkyColor.b=targetSkyColor.b/l*t*a,currentSkyColor.r+=(targetSkyColor.r-currentSkyColor.r)/10*e,currentSkyColor.g+=(targetSkyColor.g-currentSkyColor.g)/10*e,currentSkyColor.b+=(targetSkyColor.b-currentSkyColor.b)/10*e,appNodes.canvasContainer.style.backgroundColor=`rgb(${0|currentSkyColor.r}, ${0|currentSkyColor.g}, ${0|currentSkyColor.b})`}function createParticleArc(e,t,r,a,l){let o=t/r,i=e+t-.5*o;if(i>e)for(let t=e;t<i;t+=o)l(t+Math.random()*o*a);else for(let t=e;t>i;t+=o)l(t+Math.random()*o*a)}function createBurst(e,t,r=0,a=PI_2){let l=.5*Math.sqrt(e/Math.PI)*2*Math.PI,o=l/2;for(let e=0;e<=o;e++){let i=e/o*PI_HALF,s=Math.cos(i),n=l*s,h=n*(a/PI_2),d=PI_2/n,c=Math.random()*d+r,u=.33*d;for(let e=0;e<h;e++){t(d*e+c+Math.random()*u,s)}}}function crossetteEffect(e){createParticleArc(Math.random()*PI_HALF,PI_2,4,.5,(t=>{Star.add(e.x,e.y,e.color,t,.6*Math.random()+.75,600)}))}function floralEffect(e){createBurst(12+6*quality,((t,r)=>{Star.add(e.x,e.y,e.color,t,2.4*r,1e3+300*Math.random(),e.speedX,e.speedY)})),BurstFlash.add(e.x,e.y,46)}function fallingLeavesEffect(e){createBurst(7,((t,r)=>{let a=Star.add(e.x,e.y,INVISIBLE,t,2.4*r,2400+600*Math.random(),e.speedX,e.speedY);a.sparkColor=COLOR.Gold,a.sparkFreq=144/quality,a.sparkSpeed=.28,a.sparkLife=750,a.sparkLifeVariation=3.2})),BurstFlash.add(e.x,e.y,46)}function crackleEffect(e){createParticleArc(0,PI_2,isHighQuality?32:16,1.8,(t=>{Spark.add(e.x,e.y,COLOR.Gold,t,2.4*Math.pow(Math.random(),.45),300+200*Math.random())}))}mainStage.addEventListener("ticker",update);class Shell{constructor(e){if(Object.assign(this,e),this.starLifeVariation=e.starLifeVariation||.125,this.color=e.color||randomColor(),this.glitterColor=e.glitterColor||this.color,!this.starCount){let t=e.starDensity||1,r=this.spreadSize/54;this.starCount=Math.max(6,r*r*t)}}launch(e,t){let r=stageW,a=stageH-.45*stageH,l=stageH,o=Math.pow(.04*(l-(a-t*(a-50))),.64),i=this.comet=Star.add(e*(r-120)+60,l,"string"==typeof this.color&&"random"!==this.color?this.color:COLOR.White,Math.PI,o*(this.horsetail?1.2:1),o*(this.horsetail?100:400));i.heavy=!0,i.spinRadius=MyMath.random(.32,.85),i.sparkFreq=32/quality,isHighQuality&&(i.sparkFreq=8),i.sparkLife=320,i.sparkLifeVariation=3,("willow"===this.glitter||this.fallingLeaves)&&(i.sparkFreq=20/quality,i.sparkSpeed=.5,i.sparkLife=500),this.color===INVISIBLE&&(i.sparkColor=COLOR.Gold),Math.random()>.4&&!this.horsetail&&(i.secondColor=INVISIBLE,i.transitionTime=700*Math.pow(Math.random(),1.5)+500),i.onDeath=e=>this.burst(e.x,e.y)}burst(e,t){let r,a,l,o,i,s=this.spreadSize/96,n=.25,h=!1;this.crossette&&(a=e=>{h||(h=!0),crossetteEffect(e)}),this.crackle&&(a=e=>{h||(h=!0),crackleEffect(e)}),this.floral&&(a=floralEffect),this.fallingLeaves&&(a=fallingLeavesEffect),"light"===this.glitter?(l=400,o=.3,i=300,n=2):"medium"===this.glitter?(l=200,o=.44,i=700,n=2):"heavy"===this.glitter?(l=80,o=.8,i=1400,n=2):"thick"===this.glitter?(l=16,o=isHighQuality?1.65:1.5,i=1400,n=3):"streamer"===this.glitter?(l=32,o=1.05,i=620,n=2):"willow"===this.glitter&&(l=120,o=.34,i=1400,n=3.8),l/=quality;let d=(h,d)=>{let c=this.spreadSize/1800,u=Star.add(e,t,r||randomColor(),h,d*s,this.starLife+Math.random()*this.starLife*this.starLifeVariation,this.horsetail?this.comet&&this.comet.speedX:0,this.horsetail?this.comet&&this.comet.speedY:-c);this.secondColor&&(u.transitionTime=this.starLife*(.05*Math.random()+.32),u.secondColor=this.secondColor),this.strobe&&(u.transitionTime=this.starLife*(.08*Math.random()+.46),u.strobe=!0,u.strobeFreq=20*Math.random()+40,this.strobeColor&&(u.secondColor=this.strobeColor)),u.onDeath=a,this.glitter&&(u.sparkFreq=l,u.sparkSpeed=o,u.sparkLife=i,u.sparkLifeVariation=n,u.sparkColor=this.glitterColor,u.sparkTimer=Math.random()*u.sparkFreq)};if("string"==typeof this.color)if(r="random"===this.color?null:this.color,this.ring){let a=Math.random()*Math.PI,h=.85*Math.pow(Math.random(),2)+.15;createParticleArc(0,PI_2,this.starCount,0,(d=>{let c=Math.sin(d)*s*h,u=Math.cos(d)*s,S=MyMath.pointDist(0,0,c,u),p=MyMath.pointAngle(0,0,c,u)+a,m=Star.add(e,t,r,p,S,this.starLife+Math.random()*this.starLife*this.starLifeVariation);this.glitter&&(m.sparkFreq=l,m.sparkSpeed=o,m.sparkLife=i,m.sparkLifeVariation=n,m.sparkColor=this.glitterColor,m.sparkTimer=Math.random()*m.sparkFreq)}))}else createBurst(this.starCount,d);else{if(!Array.isArray(this.color))throw Error("Invalid shell color. Expected string or array of strings, but got: "+this.color);if(.5>Math.random()){let e=Math.random()*Math.PI,t=Math.PI;r=this.color[0],createBurst(this.starCount,d,e,t),r=this.color[1],createBurst(this.starCount,d,e+Math.PI,t)}else r=this.color[0],createBurst(this.starCount/2,d),r=this.color[1],createBurst(this.starCount/2,d)}if(this.pistil){new Shell({spreadSize:.5*this.spreadSize,starLife:.6*this.starLife,starLifeVariation:this.starLifeVariation,starDensity:1.4,color:this.pistilColor,glitter:"light",glitterColor:this.pistilColor===COLOR.Gold?COLOR.Gold:COLOR.White}).burst(e,t)}if(this.streamers){new Shell({spreadSize:.9*this.spreadSize,starLife:.8*this.starLife,starLifeVariation:this.starLifeVariation,starCount:Math.floor(Math.max(6,this.spreadSize/45)),color:COLOR.White,glitter:"streamer"}).burst(e,t)}BurstFlash.add(e,t,this.spreadSize/4)}}const BurstFlash={active:[],_pool:[],_new:()=>({}),add(e,t,r){let a=this._pool.pop()||this._new();return a.x=e,a.y=t,a.radius=r,this.active.push(a),a},returnInstance(e){this._pool.push(e)}};function createParticleCollection(){let e={};return COLOR_CODES_W_INVIS.forEach((t=>{e[t]=[]})),e}const Star={drawWidth:3,airDrag:.98,airDragHeavy:.992,active:createParticleCollection(),_pool:[],_new:()=>({}),add(e,t,r,a,l,o,i,s){let n=this._pool.pop()||this._new();return n.visible=!0,n.heavy=!1,n.x=e,n.y=t,n.prevX=e,n.prevY=t,n.color=r,n.speedX=Math.sin(a)*l+(i||0),n.speedY=Math.cos(a)*l+(s||0),n.life=o,n.fullLife=o,n.spinAngle=Math.random()*PI_2,n.spinSpeed=.8,n.spinRadius=0,n.sparkFreq=0,n.sparkSpeed=1,n.sparkTimer=0,n.sparkColor=r,n.sparkLife=750,n.sparkLifeVariation=.25,n.strobe=!1,this.active[r].push(n),n},returnInstance(e){e.onDeath&&e.onDeath(e),e.onDeath=null,e.secondColor=null,e.transitionTime=0,e.colorChanged=!1,this._pool.push(e)}},Spark={drawWidth:0,airDrag:.9,active:createParticleCollection(),_pool:[],_new:()=>({}),add(e,t,r,a,l,o){let i=this._pool.pop()||this._new();return i.x=e,i.y=t,i.prevX=e,i.prevY=t,i.color=r,i.speedX=Math.sin(a)*l,i.speedY=Math.cos(a)*l,i.life=o,this.active[r].push(i),i},returnInstance(e){this._pool.push(e)}};IS_HEADER?init():setTimeout(init,0);